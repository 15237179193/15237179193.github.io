<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>丁丁丁梦涛的个人博客</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.monty.site/"/>
  <updated>2019-06-30T17:14:16.240Z</updated>
  <id>http://blog.monty.site/</id>
  
  <author>
    <name>Monty Ding</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>基于阿里云服务器环境搭建到项目上线系列文章之六——项目部署</title>
    <link href="http://blog.monty.site/2019/07/01/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%88%B0%E9%A1%B9%E7%9B%AE%E4%B8%8A%E7%BA%BF%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0%E4%B9%8B%E5%85%AD%E2%80%94%E2%80%94%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2/"/>
    <id>http://blog.monty.site/2019/07/01/基于阿里云服务器环境搭建到项目上线系列文章之六——项目部署/</id>
    <published>2019-06-30T17:13:47.000Z</published>
    <updated>2019-06-30T17:14:16.240Z</updated>
    
    <content type="html"><![CDATA[<p><strong>基于阿里云服务器环境搭建到项目上线系列</strong><br>前言：最近购买了域名和一台阿里云服务器准备做点东西放上去，所以准备把环境搭建到项目上线的过程记录下来，计划一个系列6篇文章</p><ol><li><a href="https://blog.csdn.net/dmt742055597/article/details/92404823" target="_blank" rel="noopener">基于阿里云服务器环境搭建到项目上线系列文章之一——putty使用秘钥登录远程服务器</a></li><li><a href="https://blog.csdn.net/dmt742055597/article/details/92405921" target="_blank" rel="noopener">基于阿里云服务器环境搭建到项目上线系列文章之二——搭建LNMP环境</a></li><li><a href="https://blog.csdn.net/dmt742055597/article/details/92406121" target="_blank" rel="noopener">基于阿里云服务器环境搭建到项目上线系列文章之三——安装git</a></li><li><a href="https://blog.csdn.net/dmt742055597/article/details/92406290" target="_blank" rel="noopener">基于阿里云服务器环境搭建到项目上线系列文章之四——安装composer</a></li><li><a href="https://blog.csdn.net/dmt742055597/article/details/92406520" target="_blank" rel="noopener">基于阿里云服务器环境搭建到项目上线系列文章之五——项目仓库github基本使用</a></li><li><a href="https://blog.csdn.net/dmt742055597/article/details/92406688" target="_blank" rel="noopener">基于阿里云服务器环境搭建到项目上线系列文章之六——项目部署</a></li></ol><p>@<a href="基于阿里云服务器环境搭建到项目上线系列文章之六——项目部署">TOC</a></p><h1 id="MYSQL数据库部署"><a href="#MYSQL数据库部署" class="headerlink" title="MYSQL数据库部署"></a>MYSQL数据库部署</h1><h2 id="允许远程连接服务器数据库"><a href="#允许远程连接服务器数据库" class="headerlink" title="允许远程连接服务器数据库"></a>允许远程连接服务器数据库</h2><ul><li><p>设置允许远程连接前，测试连接：<br><img src="https://img-blog.csdnimg.cn/20190617145621984.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RtdDc0MjA1NTU5Nw==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p></li><li><p>设置允许远程连接<br>登录服务器，登录mysql</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">输入密码：******</span><br><span class="line">执行如下命令：</span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO &apos;root&apos;@&apos;%&apos; IDENTIFIED BY &apos;你的数据库密码&apos; WITH GRANT OPTION;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><p>  此时，再连接服务器MySQL数据库，提示连接成功，如下:</p><p>  <img src="https://img-blog.csdnimg.cn/20190617153904116.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RtdDc0MjA1NTU5Nw==,size_16,color_FFFFFF,t_70" alt="这说明允许远程连接设置已经成功了，但是我的ip地址连接强求被拒绝，此时可能是因为阿里云安全限制，需要去阿里云控制台设置3306安全组和ip白名单。"></p><h2 id="新增项目数据库用户和权限"><a href="#新增项目数据库用户和权限" class="headerlink" title="新增项目数据库用户和权限"></a>新增项目数据库用户和权限</h2></li><li><p>新增项目数据库</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database yishubj character set = utf8;</span><br></pre></td></tr></table></figure></li><li><p>新增专属项目数据库用户</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &apos;yishubj&apos;@&apos;%&apos; IDENTIFIED BY &apos;设置此用户密码&apos;;</span><br><span class="line">GRANT ALL PRIVILEGES ON yishubj.* TO &apos;yishubj&apos;@&apos;%&apos;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure><p>  服务器端MySQL登录成功，如图：<br>  <img src="https://img-blog.csdnimg.cn/20190617154651805.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RtdDc0MjA1NTU5Nw==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="项目数据库初始化"><a href="#项目数据库初始化" class="headerlink" title="项目数据库初始化"></a>项目数据库初始化</h2><p>把自己设置的数据库表文件通过上面Navicat连接工具导入对应数据库即可，步骤如下：</p></li><li><p>双击打开上一步创建的数据库（yishubj），右键该数据库名称（yishubj）=&gt;运行SQL文件，跳出弹窗</p></li><li><p>选中要导入的数据库表结构数据文件，设置编码，点击开始：<br><img src="https://img-blog.csdnimg.cn/2019061715545026.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RtdDc0MjA1NTU5Nw==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>导入成功，会有成功提示，导入失败会有失败提示，如果失败，说明SQL文件有问题，请根据提示修改。<br><img src="https://img-blog.csdnimg.cn/20190617155813503.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RtdDc0MjA1NTU5Nw==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h1 id="nginx配置部署"><a href="#nginx配置部署" class="headerlink" title="nginx配置部署"></a>nginx配置部署</h1><h2 id="新增域名配置文件"><a href="#新增域名配置文件" class="headerlink" title="新增域名配置文件"></a>新增域名配置文件</h2></li><li><p>登录服务器，创建域名配置文件</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/nginx/conf.d/</span><br><span class="line"></span><br><span class="line">touch www_yishubj.conf</span><br><span class="line">#域名文件随意定义，以conf为文件后缀，会自动加载到nginx.conf文件内</span><br></pre></td></tr></table></figure></li></ul><h2 id="新增配置内容"><a href="#新增配置内容" class="headerlink" title="新增配置内容"></a>新增配置内容</h2><ul><li><p>执行命令打开配置文件</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/nginx/conf.d/</span><br><span class="line">vim www_yishubj.conf</span><br></pre></td></tr></table></figure></li><li><p>直接上配置文件，将如下内容添加到文件内。如使用该配置文件，需要修改的地方下面会列出：</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name www.yishubj.com m.yishubj.com;</span><br><span class="line">    charset utf8;</span><br><span class="line">    root    /home/www/mozhilin/;</span><br><span class="line">    index  index.php index.html index.htm;</span><br><span class="line"></span><br><span class="line">    client_max_body_size 200m;</span><br><span class="line">    client_body_buffer_size 4096k;</span><br><span class="line">    underscores_in_headers on;</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    #access_log  /var/log/nginx/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        #root   /usr/share/nginx/html;</span><br><span class="line">        #index  index.html index.htm;</span><br><span class="line"></span><br><span class="line">try_files $uri $uri/ /index.php?&amp;$args /index.php?$query_string;</span><br><span class="line">if (!-e $request_filename)&#123;</span><br><span class="line">    rewrite ^/(.*) /index.php last;</span><br><span class="line">&#125; </span><br><span class="line">allow all;</span><br><span class="line"></span><br><span class="line">#include /etc/nginx/cors.conf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location = /favicon.ico &#123;</span><br><span class="line">            log_not_found off;</span><br><span class="line">            access_log off;</span><br><span class="line">    &#125;</span><br><span class="line">    location = /robots.txt &#123;</span><br><span class="line">            allow all;</span><br><span class="line">            log_not_found off;</span><br><span class="line">            access_log off;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~* \.(css|png|jpg|jpeg|ico)$ &#123;</span><br><span class="line">            expires max;</span><br><span class="line">            log_not_found off;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ /(assets|upfile|uploads|tmp|log|css|js|images|statics|demo)/.*\.(php|php5)?$ &#123;</span><br><span class="line">            #deny all;</span><br><span class="line">            allow all;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ /(\.svn|\.git|\.ht|\.DS) &#123;</span><br><span class="line">            deny all;</span><br><span class="line">            internal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php($|/) &#123;</span><br><span class="line">            fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">            fastcgi_index  index.php;</span><br><span class="line">            fastcgi_split_path_info  ^(.+\.php)(.*)$;</span><br><span class="line">            fastcgi_param  PATH_INFO $fastcgi_path_info;</span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">            fastcgi_param    PATH_TRANSLATED    $document_root$fastcgi_path_info;</span><br><span class="line">            fastcgi_param  CI_ENV &apos;development&apos;;</span><br><span class="line">        fastcgi_param access_token $http_access_token;</span><br><span class="line">   fastcgi_param refresh_token $http_refresh_token;</span><br><span class="line">            include        fastcgi_params;</span><br><span class="line">            #include        fastcgi.conf;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">    # redirect server error pages to the static page /50x.html</span><br><span class="line">    #</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line">    #</span><br><span class="line">    #location ~ \.php$ &#123;</span><br><span class="line">    #    proxy_pass   http://127.0.0.1;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">    #</span><br><span class="line">    #location ~ \.php$ &#123;</span><br><span class="line">    #    root           html;</span><br><span class="line">    #    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">    #    fastcgi_index  index.php;</span><br><span class="line">    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">    #    include        fastcgi_params;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">    # deny access to .htaccess files, if Apache&apos;s document root</span><br><span class="line">    # concurs with nginx&apos;s one</span><br><span class="line">    #</span><br><span class="line">    #location ~ /\.ht &#123;</span><br><span class="line">    #    deny  all;</span><br><span class="line">    #&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>用到自己的环境中，需要修改的配置，如下：</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server_name www.yishubj.com m.yishubj.com;#改为自己网站的域名</span><br><span class="line">   root    /home/www/mozhilin/;#改为自己项目在服务器上的目录地址</span><br></pre></td></tr></table></figure></li></ul><h1 id="PHP项目部署"><a href="#PHP项目部署" class="headerlink" title="PHP项目部署"></a>PHP项目部署</h1><h2 id="数据库连接配置"><a href="#数据库连接配置" class="headerlink" title="数据库连接配置"></a>数据库连接配置</h2><ul><li>设置database.php文件数据库连接  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$db[&apos;default&apos;]= [</span><br><span class="line">    &apos;hostname&apos;=&gt; &apos;127.0.0.1&apos;,</span><br><span class="line">    &apos;username&apos;=&gt; &apos;yishubj&apos;,</span><br><span class="line">    &apos;password&apos;=&gt; &apos;用户yishubj对应的密码&apos;,</span><br><span class="line">    &apos;database&apos;=&gt; &apos;yishubj&apos;,</span><br><span class="line">    &apos;DBPrefix&apos;=&gt; &apos;ysbj_&apos;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">#这里根据自己的数据库配置文件填写相应信息，不同的框架配置文件不同，需灵活运用。</span><br></pre></td></tr></table></figure></li></ul><h2 id="目录访问权限配置"><a href="#目录访问权限配置" class="headerlink" title="目录访问权限配置"></a>目录访问权限配置</h2><ul><li>初次访问网站，可能会有提示某些目录没有访问权限，如cache、uploadfile、vendor等目录，这时，需要开发者登录到服务器进行权限设置</li><li>cache和uploadfile目录对www用户有写权限，这里是我项目的示例：  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /home/www/yishubj/</span><br><span class="line">   chmod -R 777 cache</span><br><span class="line">   chmod -R 777 uploadfile</span><br></pre></td></tr></table></figure></li></ul><p>至此，服务器项目部署上线工作已经完成，希望对阅读者有所帮助，且能够学会灵活运用，而不是照搬照抄。</p><p>********************<strong>只要思想不滑坡，办法总比困难多</strong>********************</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;基于阿里云服务器环境搭建到项目上线系列&lt;/strong&gt;&lt;br&gt;前言：最近购买了域名和一台阿里云服务器准备做点东西放上去，所以准备把环境搭建到项目上线的过程记录下来，计划一个系列6篇文章&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;https://blog.
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>基于CI（codeigniter）3框架接入支付宝PC网站支付详细步骤</title>
    <link href="http://blog.monty.site/2019/06/30/%E5%9F%BA%E4%BA%8ECI%EF%BC%88codeigniter%EF%BC%893%E6%A1%86%E6%9E%B6%E6%8E%A5%E5%85%A5%E6%94%AF%E4%BB%98%E5%AE%9DPC%E7%BD%91%E7%AB%99%E6%94%AF%E4%BB%98%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4/"/>
    <id>http://blog.monty.site/2019/06/30/基于CI（codeigniter）3框架接入支付宝PC网站支付详细步骤/</id>
    <published>2019-06-30T14:27:29.000Z</published>
    <updated>2019-06-30T17:41:32.274Z</updated>
    
    <content type="html"><![CDATA[<p>本文是基于PHP框架CI3.X开发的接入支付宝PC网站支付流程步骤，是从注册成为支付宝支付开发者的沙箱环境，到正式支付服务签约，一级接口业务开发，和开发过程中遇到的问题，还有相应的解决方案。旨在记录开发过程，期望为初次接触支付宝支付的开发者提供一个思路。</p><p><img src="http://ptx9vod5s.bkt.clouddn.com/blog/alipay-sum.png" alt="总览图"></p><p>@[toc]</p><h1 id="项目环境"><a href="#项目环境" class="headerlink" title="项目环境"></a>项目环境</h1><ul><li><p>PHP语言CI(codeigniter)3.x框架</p></li><li><p>测试环境：windows，发布环境：CentOS7</p></li></ul><h1 id="注册成为支付宝开发者"><a href="#注册成为支付宝开发者" class="headerlink" title="注册成为支付宝开发者"></a>注册成为支付宝开发者</h1><p>支付宝PC电脑支付文档传送门：<a href="https://docs.open.alipay.com/270/105898/" target="_blank" rel="noopener">点这里</a></p><h2 id="申请成为开发者"><a href="#申请成为开发者" class="headerlink" title="申请成为开发者"></a>申请成为开发者</h2><ol><li><p>支付宝扫码登录<a href="https://openhome.alipay.com/platform/home.htm" target="_blank" rel="noopener">蚂蚁金服开放平台</a>；</p></li><li><p>选择“开发中心=&gt;研发服务”，如图：<br><img src="http://ptx9vod5s.bkt.clouddn.com/blog/alipay-pc-01.png" alt="在这里插入图片描述"> </p></li><li><p>下载秘钥生成工具，传送门：<a href="https://docs.open.alipay.com/291/105971" target="_blank" rel="noopener">点这里</a><br> 注意：需要吧下载的文件放到非中文目录的目录下面才可以正常生成秘钥，否则，如果文件夹名称中包含中文，将会出现闪退情况。<br> <img src="http://ptx9vod5s.bkt.clouddn.com/blog/alipay-pc-02.png" alt="在这里插入图片描述"><br>同时，生工具同级目录下会生成公钥私钥文件，java语言选择私钥文件是rsa_private_key_pkcs8.pem，其他语言选择私钥文件是rsa_private_key.pem </p></li><li><p>把第三步生成的公钥复制并保存到下图中RSA2对应的支付宝公钥里面：<br><img src="http://ptx9vod5s.bkt.clouddn.com/blog/alipay-pc-03.png" alt="在这里插入图片描述"><br>私钥文件自己保存好，下面的支付配置文件中会用到。</p></li><li><p>下载沙箱支付测试工具，注意仅支持安卓版本：<br><img src="http://ptx9vod5s.bkt.clouddn.com/blog/alipay-pc-04.png" alt="在这里插入图片描述"></p><h2 id="正式环境支付签约"><a href="#正式环境支付签约" class="headerlink" title="正式环境支付签约"></a>正式环境支付签约</h2><p>参考文档：<a href="https://blog.csdn.net/meixi_android/article/details/86489870" target="_blank" rel="noopener">https://blog.csdn.net/meixi_android/article/details/86489870</a></p><h1 id="项目接入支付宝SDK"><a href="#项目接入支付宝SDK" class="headerlink" title="项目接入支付宝SDK"></a>项目接入支付宝SDK</h1><h2 id="获取SDK"><a href="#获取SDK" class="headerlink" title="获取SDK"></a>获取SDK</h2><p>官方SDK下载地址：<a href="https://docs.open.alipay.com/270/106291/" target="_blank" rel="noopener">SDK传送门</a><br>我项目里没有使用官方SDK，这里使用的是github一个大神提供的支付宝支付和微信支付集成的包，</p></li></ol><p>GitBook传送门：<a href="https://docs.pay.yansongda.cn/" target="_blank" rel="noopener">点这里</a><br>GitHub传送门：<a href="https://github.com/yansongda/pay/blob/master/README.md" target="_blank" rel="noopener">点这里</a></p><p>根据文档要求在项目根目录执行composer，安装sdk包：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require yansongda/pay -vvv</span><br></pre></td></tr></table></figure><p>安装完成后会发现vendor目录多了几个文件夹目录，这都是该SDK的依赖包：<br><img src="http://ptx9vod5s.bkt.clouddn.com/blog/alipay-pc-05.png" alt="在这里插入图片描述"></p><h1 id="支付配置"><a href="#支付配置" class="headerlink" title="支付配置"></a>支付配置</h1><p>文档中的示例吧配置文件写到了控制器里面，但是不够优雅，我决定把配置文件提取出来放到一个专门的配置文件中：<br><img src="http://ptx9vod5s.bkt.clouddn.com/blog/alipay-pc-06.png" alt="在这里插入图片描述"><br>配置文件：pay_config.php：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">defined(&apos;BASEPATH&apos;) OR exit(&apos;No direct script access allowed&apos;);</span><br><span class="line">/**</span><br><span class="line"> * Created by PhpStorm.</span><br><span class="line"> * User: 15237</span><br><span class="line"> * Date: 2019/6/22</span><br><span class="line"> * Time: 15:34</span><br><span class="line"> */</span><br><span class="line">$http = &apos;http://&apos;;</span><br><span class="line">$domain = $_SERVER[&apos;HTTP_HOST&apos;];</span><br><span class="line">$sub_domain = explode(&apos;.&apos;, $domain)[1];</span><br><span class="line">$http_domain = $http.$domain;</span><br><span class="line">$notify_url = $http_domain.&apos;/assemble_pay/ali_pay_notify&apos;;//异步回调通知接口地址</span><br><span class="line">$return_url = $http_domain.&apos;/assemble_pay/ali_pay_return&apos;;//同步回调通知接口地址</span><br><span class="line"></span><br><span class="line">if($sub_domain == &apos;ihibuilding&apos;)&#123;</span><br><span class="line">    $cfg_ary = [</span><br><span class="line">        //企业沙箱</span><br><span class="line">        &apos;app_id&apos; =&gt; &apos;你的apiiid&apos;,//去支付宝平台查看</span><br><span class="line">        &apos;ali_public_key&apos; =&gt; &apos;支付宝公钥&apos;,//注意这里是公钥，而不是应用公钥，一定要与上面支付宝开发者填的保证一直，否则支付时会有错误提示</span><br><span class="line">        &apos;private_key&apos; =&gt; &apos;你生成的私钥文件里面的内容&apos;,//由于生成的私钥文件内有回车键，需要吧回车键去掉，私钥内容是-----BEGIN RSA PRIVATE KEY-----与-----END RSA PRIVATE KEY-----之间的字符串，首行和尾行禁止包含</span><br><span class="line">        &apos;mode&apos; =&gt; &apos;dev&apos;, // optional,设置此参数，将进入沙箱模式，改参数是指定使用支付宝网关正式地址还是还发地址的</span><br><span class="line">    ];</span><br><span class="line">&#125;else if($sub_domain == &apos;hibuilding&apos;)&#123;</span><br><span class="line">    $cfg_ary = [</span><br><span class="line">        //正式环境</span><br><span class="line">        &apos;app_id&apos; =&gt; &apos;你的apiiid&apos;,//去支付宝平台查看</span><br><span class="line">        &apos;ali_public_key&apos; =&gt; &apos;支付宝公钥&apos;,//注意这里是公钥，而不是应用公钥，一定要与上面支付宝开发者填的保证一直，否则支付时会有错误提示</span><br><span class="line">        &apos;private_key&apos; =&gt; &apos;你生成的私钥文件里面的内容&apos;,//由于生成的私钥文件内有回车键，需要吧回车键去掉，私钥内容是-----BEGIN RSA PRIVATE KEY-----与-----END RSA PRIVATE KEY-----之间的字符串，首行和尾行禁止包含</span><br><span class="line">    ];</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    $cfg_ary = [</span><br><span class="line">        //企业沙箱</span><br><span class="line">         &apos;app_id&apos; =&gt; &apos;你的apiiid&apos;,//去支付宝平台查看</span><br><span class="line">        &apos;ali_public_key&apos; =&gt; &apos;支付宝公钥&apos;,//注意这里是公钥，而不是应用公钥，一定要与上面支付宝开发者填的保证一直，否则支付时会有错误提示</span><br><span class="line">        &apos;private_key&apos; =&gt; &apos;你生成的私钥文件里面的内容&apos;,//由于生成的私钥文件内有回车键，需要吧回车键去掉，私钥内容是-----BEGIN RSA PRIVATE KEY-----与-----END RSA PRIVATE KEY-----之间的字符串，首行和尾行禁止包含</span><br><span class="line">        &apos;mode&apos; =&gt; &apos;dev&apos;, // optional,设置此参数，将进入沙箱模式</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$common = [</span><br><span class="line">    &apos;notify_url&apos; =&gt; $notify_url,</span><br><span class="line">    &apos;return_url&apos; =&gt; $return_url,</span><br><span class="line">    // 加密方式： **RSA2**</span><br><span class="line">    &apos;log&apos; =&gt; [ // optional</span><br><span class="line">        &apos;file&apos; =&gt; &apos;./logs/alipay.log&apos;,</span><br><span class="line">        &apos;level&apos; =&gt; &apos;info&apos;, // 建议生产环境等级调整为 info，开发环境为 debug</span><br><span class="line">        &apos;type&apos; =&gt; &apos;single&apos;, // optional, 可选 daily.</span><br><span class="line">        &apos;max_file&apos; =&gt; 30, // optional, 当 type 为 daily 时有效，默认 30 天</span><br><span class="line">    ],</span><br><span class="line">    &apos;http&apos; =&gt; [ // optional</span><br><span class="line">        &apos;timeout&apos; =&gt; 5.0,</span><br><span class="line">        &apos;connect_timeout&apos; =&gt; 5.0,</span><br><span class="line">        // 更多配置项请参考 [Guzzle](https://guzzle-cn.readthedocs.io/zh_CN/latest/request-options.html)</span><br><span class="line">    ],</span><br><span class="line">];</span><br><span class="line">$config[&apos;ali_pay_cfg&apos;] = array_merge($cfg_ary, $common);</span><br></pre></td></tr></table></figure><h1 id="支付业务实现"><a href="#支付业务实现" class="headerlink" title="支付业务实现"></a>支付业务实现</h1><h2 id="初始化配置等"><a href="#初始化配置等" class="headerlink" title="初始化配置等"></a>初始化配置等</h2><h2 id="发起支付代码"><a href="#发起支付代码" class="headerlink" title="发起支付代码"></a>发起支付代码</h2><h2 id="异步回调代码"><a href="#异步回调代码" class="headerlink" title="异步回调代码"></a>异步回调代码</h2><h2 id="同步回调代码"><a href="#同步回调代码" class="headerlink" title="同步回调代码"></a>同步回调代码</h2><p>以上四步全部写在下面的两个文件中，开发者可以参考：<br>控制器文件，Assemble_pay.php：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">defined(&apos;BASEPATH&apos;) OR exit(&apos;No direct script access allowed&apos;);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 使用该支付需要注意的地方：</span><br><span class="line"> * 0.部署支付sdk时，需要执行 composer require yansongda/pay -vvv ，或将 &quot;yansongda/pay&quot;: &quot;^2.7&quot; 加入到composer.json 中</span><br><span class="line"> * 1.开启PHP扩展openssl</span><br><span class="line"> * 2.开启mbstring.encoding_translation</span><br><span class="line"> * 3.为了保证异步回调通知验签成功，需要在 vendor/yansongda/pay/src/Gateways/Alipay.php 中，</span><br><span class="line"> *   把：</span><br><span class="line"> *   const URL = [</span><br><span class="line">        self::MODE_NORMAL =&gt; &apos;https://openapi.alipay.com/gateway.do&apos;,</span><br><span class="line">        self::MODE_DEV    =&gt; &apos;https://openapi.alipaydev.com/gateway.do&apos;,</span><br><span class="line">     ];</span><br><span class="line"> *   改为：</span><br><span class="line"> *   const URL = [</span><br><span class="line">        self::MODE_NORMAL =&gt; &apos;https://openapi.alipay.com/gateway.do?charset=utf-8&apos;,</span><br><span class="line">        self::MODE_DEV    =&gt; &apos;https://openapi.alipaydev.com/gateway.do?charset=utf-8&apos;,</span><br><span class="line">     ];</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by PhpStorm.</span><br><span class="line"> * User: 15237</span><br><span class="line"> * Date: 2019/6/22</span><br><span class="line"> * Time: 15:16</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">use Yansongda\Pay\Pay;</span><br><span class="line">use Yansongda\Pay\Log;</span><br><span class="line">use Yansongda\Pay\Gateways\Alipay;</span><br><span class="line">use Symfony\Component\HttpFoundation\Response;</span><br><span class="line">use Yansongda\Supports\Config;</span><br><span class="line"></span><br><span class="line">class Assemble_pay extends PS_Controller</span><br><span class="line">&#123;</span><br><span class="line">    public $CI;</span><br><span class="line">    protected $alipay_cfg;</span><br><span class="line">    protected $wechat_pay_cfg;</span><br><span class="line">    protected $alipay;//支付宝支付对象</span><br><span class="line">    protected $wechatpay;//微信支付对象</span><br><span class="line"></span><br><span class="line">    function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        parent::__construct();</span><br><span class="line"></span><br><span class="line">        $this-&gt;CI = get_instance();</span><br><span class="line"></span><br><span class="line">        $this-&gt;alipay_cfg = $this-&gt;config-&gt;item(&apos;ali_pay_cfg&apos;);</span><br><span class="line">        $this-&gt;wechat_pay_cfg = $this-&gt;config-&gt;item(&apos;wechat_pay_cfg&apos;);</span><br><span class="line"></span><br><span class="line">        $this-&gt;CI-&gt;load-&gt;helper(&apos;pay&apos;);</span><br><span class="line"></span><br><span class="line">        $this-&gt;alipay = Pay::alipay($this-&gt;alipay_cfg);</span><br><span class="line">        //$this-&gt;wechatpay = Pay::wechat($this-&gt;wechat_pay_cfg);</span><br><span class="line"></span><br><span class="line">        $this-&gt;load-&gt;service(&apos;assemble_pay_service&apos;, &apos;&apos;, &apos;assemble_pay_s&apos;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function pay()</span><br><span class="line">    &#123;</span><br><span class="line">        $params = $this-&gt;input-&gt;post();</span><br><span class="line">        $test = [</span><br><span class="line">            &apos;pay_type&apos; =&gt; &apos;ali_pay&apos;,</span><br><span class="line">            &apos;pay_way&apos; =&gt; &apos;web&apos;,</span><br><span class="line">            &apos;order_no&apos; =&gt; &apos;15614439004&apos;,</span><br><span class="line">        ];</span><br><span class="line">        $params = !empty($params) ? $params : $test;</span><br><span class="line"></span><br><span class="line">        $res = $this-&gt;assemble_pay_s-&gt;pay_serv($params);</span><br><span class="line"></span><br><span class="line">        //output_data([&apos;html&apos; =&gt; $res]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 方法 ali_pay_return，支付宝支付同步回调接口</span><br><span class="line">     *</span><br><span class="line">     */</span><br><span class="line">    public function ali_pay_return()</span><br><span class="line">    &#123;</span><br><span class="line">        $params = $this-&gt;input-&gt;get();</span><br><span class="line"></span><br><span class="line">        $result = $this-&gt;alipay-&gt;verify(); // 是的，验签就这么简单！</span><br><span class="line"></span><br><span class="line">        $params = deal_ary_trim($params);</span><br><span class="line">        $trade_no = htmlspecialchars($params[&apos;trade_no&apos;]);</span><br><span class="line">        $params[&apos;total_amount&apos;] = $params[&apos;total_amount&apos;]*100;</span><br><span class="line"></span><br><span class="line">        //实际验证过程建议商户添加以下校验。</span><br><span class="line">        //1、商户需要验证该通知数据中的out_trade_no是否为商户系统中创建的订单号，</span><br><span class="line">        //2、判断total_amount是否确实为该订单的实际金额（即商户订单创建时的金额），</span><br><span class="line">        //3、校验通知中的seller_id（或者seller_email) 是否为out_trade_no这笔单据的对应的操作方（有的时候，一个商户可能有多个seller_id/seller_email）</span><br><span class="line">        //4、验证app_id是否为该商户本身。</span><br><span class="line">        $order = $this-&gt;check_ali_pay_params($params, 3);</span><br><span class="line"></span><br><span class="line">        if($result) &#123;//验证成功</span><br><span class="line">            //请在这里加上商户的业务逻辑程序代码</span><br><span class="line">            //修改订单状态</span><br><span class="line">            if(empty($order))&#123;</span><br><span class="line">                $order_where = [&apos;order_no&apos;=&gt;$params[&apos;out_trade_no&apos;]];</span><br><span class="line">                $order_data = [</span><br><span class="line">                    &apos;order_status&apos;=&gt;3,</span><br><span class="line">                    &apos;pay_date&apos;=&gt;$params[&apos;timestamp&apos;],</span><br><span class="line">                    &apos;pay_money&apos;=&gt;$params[&apos;total_amount&apos;],</span><br><span class="line">                    &apos;trade_no&apos;=&gt;$trade_no,</span><br><span class="line">                    &apos;trade_date&apos;=&gt;$params[&apos;timestamp&apos;],</span><br><span class="line">                ];</span><br><span class="line">                $this-&gt;assemble_pay_s-&gt;update_order_serv($order_where, $order_data);</span><br><span class="line">            &#125;</span><br><span class="line">            //获取订单信息</span><br><span class="line">            $order_info_where = [&apos;o.order_no&apos; =&gt; $params[&apos;out_trade_no&apos;], &apos;order_status&apos; =&gt; 3];//1，未支付，3：已支付，4：关闭，5：完成</span><br><span class="line">            $order = $this-&gt;assemble_pay_s-&gt;get_order_info_serv($order_info_where);</span><br><span class="line">            //增加收支流水记录</span><br><span class="line">            //查看是否有订单流水产生，有则不处理，无则需要添加</span><br><span class="line">            $order_bill = $this-&gt;assemble_pay_s-&gt;get_order_bill_info_serv([&apos;order_id&apos;=&gt;$order[&apos;order_id&apos;]]);</span><br><span class="line">            if(empty($order_bill))&#123;</span><br><span class="line">                $this-&gt;create_order_bill($order, $trade_no);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            //——请根据您的业务逻辑来编写程序（以下代码仅作参考）——</span><br><span class="line">            //获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表</span><br><span class="line">            //商户订单号</span><br><span class="line">            //$out_trade_no = htmlspecialchars($params[&apos;out_trade_no&apos;]);</span><br><span class="line">            //支付宝交易号</span><br><span class="line">            //echo &quot;验证成功&lt;br /&gt;支付宝交易号：&quot;.$trade_no;</span><br><span class="line">            //echo &apos;&lt;br/&gt;去支付页查看订单信息吧！&lt;br/&gt;&apos;;</span><br><span class="line">            $data[&apos;res&apos;] = &apos;success&apos;;</span><br><span class="line">            $data[&apos;message&apos;] = &apos;验证支付成功。&lt;/br&gt;支付宝交易号：%s &lt;/br&gt;去支付页查看订单信息吧！&lt;/br&gt;&apos;;</span><br><span class="line">            $data[&apos;trade_no&apos;] = $trade_no;</span><br><span class="line">            //——请根据您的业务逻辑来编写程序（以上代码仅作参考）——</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //验证失败</span><br><span class="line">            //echo &quot;验证失败&lt;/br&gt;&quot;;</span><br><span class="line">            //echo &apos;请去支付页确认问题！&apos;;</span><br><span class="line">            $data[&apos;res&apos;] = &apos;fail&apos;;</span><br><span class="line">            $data[&apos;message&apos;] = &apos;验证失败。&lt;/br&gt;请去支付页确认问题！&lt;/br&gt;&apos;;</span><br><span class="line">        &#125;</span><br><span class="line">        $this-&gt;load-&gt;view(&apos;assemble_pay/ali_pay_return&apos;, $data);</span><br><span class="line">        // 订单号：$data-&gt;out_trade_no</span><br><span class="line">        // 支付宝交易号：$data-&gt;trade_no</span><br><span class="line">        // 订单总金额：$data-&gt;total_amount</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 方法 ali_pay_notify，支付宝支付异步回调接口</span><br><span class="line">     *</span><br><span class="line">     */</span><br><span class="line">    public function ali_pay_notify()</span><br><span class="line">    &#123;</span><br><span class="line">        //接收待验签的数据</span><br><span class="line">        $input_stream = $this-&gt;input-&gt;raw_input_stream;</span><br><span class="line">        $input_stream = html_entity_decode(htmlspecialchars(iconv(&apos;GBK&apos;, &apos;UTF-8&apos;, urldecode($input_stream))));</span><br><span class="line">        $input_stream_ary = explode(&apos;&amp;&apos;, $input_stream);</span><br><span class="line">        $data = array();</span><br><span class="line">        foreach($input_stream_ary as $value)&#123;</span><br><span class="line">            $value_ary = explode(&apos;=&apos;, $value);</span><br><span class="line">            if($value_ary[0] == &apos;sign&apos;)&#123;</span><br><span class="line">                $data[$value_ary[0]] = mb_substr($value, 5);</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                $data[$value_ary[0]] = $value_ary[1];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        file_put_contents(FCPATH.&quot;logs/post.log&quot;, json_encode($input_stream).PHP_EOL);</span><br><span class="line">        file_put_contents(FCPATH.&quot;logs/post.log&quot;, json_encode($data).PHP_EOL);</span><br><span class="line"></span><br><span class="line">        try&#123;</span><br><span class="line">            $result = $this-&gt;alipay-&gt;verify($data); // 是的，验签就这么简单！</span><br><span class="line">            $params = $result-&gt;all();</span><br><span class="line"></span><br><span class="line">            $trade_status = $result-&gt;get(&apos;trade_status&apos;);</span><br><span class="line">            $params[&apos;total_amount&apos;] = $result-&gt;get(&apos;total_amount&apos;)*100;</span><br><span class="line">            $trade_no = $result-&gt;get(&apos;trade_no&apos;);</span><br><span class="line"></span><br><span class="line">            // 请自行对 trade_status 进行判断及其它逻辑进行判断，在支付宝的业务通知中，只有交易通知状态为 TRADE_SUCCESS 或 TRADE_FINISHED 时，支付宝才会认定为买家付款成功。</span><br><span class="line">            // 1、商户需要验证该通知数据中的out_trade_no是否为商户系统中创建的订单号；</span><br><span class="line">            // 2、判断total_amount是否确实为该订单的实际金额（即商户订单创建时的金额）；</span><br><span class="line">            // 3、校验通知中的seller_id（或者seller_email) 是否为out_trade_no这笔单据的对应的操作方（有的时候，一个商户可能有多个seller_id/seller_email）；</span><br><span class="line">            // 4、验证app_id是否为该商户本身。</span><br><span class="line">            // 5、其它业务逻辑情况</span><br><span class="line">            $order = $this-&gt;check_ali_pay_params($params, 1);</span><br><span class="line"></span><br><span class="line">            if($result) &#123;//验证成功</span><br><span class="line">                /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">                //请在这里加上商户的业务逻辑程序代</span><br><span class="line">                //订单状态未修改，这里进行再次处理</span><br><span class="line">                $order_data = [</span><br><span class="line">                    &apos;order_status&apos;=&gt;3,</span><br><span class="line">                    &apos;pay_date&apos;=&gt;$result-&gt;get(&apos;gmt_payment&apos;),</span><br><span class="line">                    &apos;pay_money&apos;=&gt;$result-&gt;get(&apos;total_amount&apos;)*100,</span><br><span class="line">                    &apos;trade_no&apos;=&gt;$trade_no,</span><br><span class="line">                    &apos;trade_date&apos;=&gt;$result-&gt;get(&apos;notify_time&apos;),</span><br><span class="line">                    &apos;pay_user&apos; =&gt; $result-&gt;get(&apos;buyer_id&apos;),</span><br><span class="line">                    &apos;trade_result&apos; =&gt; $trade_status</span><br><span class="line">                ];</span><br><span class="line">                $order_where = [&apos;order_no&apos;=&gt;$result-&gt;get(&apos;out_trade_no&apos;)];</span><br><span class="line">                $this-&gt;assemble_pay_s-&gt;update_order_serv($order_where, $order_data);</span><br><span class="line">                //增加订单流水记录</span><br><span class="line">                $this-&gt;create_order_bill($order, $trade_no);</span><br><span class="line"></span><br><span class="line">                //——请根据您的业务逻辑来编写程序（以下代码仅作参考）——</span><br><span class="line">                //获取支付宝的通知返回参数，可参考技术文档中服务器异步通知参数列表</span><br><span class="line">                //商户订单号</span><br><span class="line">                //$out_trade_no = $params[&apos;out_trade_no&apos;];</span><br><span class="line">                //支付宝交易号</span><br><span class="line">                //$trade_no = $params[&apos;trade_no&apos;];</span><br><span class="line">                //交易状态</span><br><span class="line">                if($trade_status == &apos;TRADE_FINISHED&apos;) &#123;</span><br><span class="line">                    //判断该笔订单是否在商户网站中已经做过处理</span><br><span class="line">                    //如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序</span><br><span class="line">                    //请务必判断请求时的total_amount与通知时获取的total_fee为一致的</span><br><span class="line">                    //如果有做过处理，不执行商户的业务程序</span><br><span class="line">                    //注意：</span><br><span class="line">                    //退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知</span><br><span class="line">                &#125;else if ($trade_status == &apos;TRADE_SUCCESS&apos;) &#123;</span><br><span class="line">                    //判断该笔订单是否在商户网站中已经做过处理</span><br><span class="line">                    //如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序</span><br><span class="line">                    //请务必判断请求时的total_amount与通知时获取的total_fee为一致的</span><br><span class="line">                    //如果有做过处理，不执行商户的业务程序</span><br><span class="line">                    //注意：</span><br><span class="line">                    //付款完成后，支付宝系统发送该交易状态通知</span><br><span class="line">                &#125;</span><br><span class="line">                //——请根据您的业务逻辑来编写程序（以上代码仅作参考）——</span><br><span class="line">                //header(&quot;HTTP/1.1 200 OK&quot;);</span><br><span class="line">                echo &quot;success&quot;;//请不要修改或删除</span><br><span class="line">                //$res = true;</span><br><span class="line">            &#125;else &#123;</span><br><span class="line">                //验证失败</span><br><span class="line">                echo &quot;fail&quot;;</span><br><span class="line">                //$res = false;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log::debug(&apos;Alipay notify&apos;, $result-&gt;all());</span><br><span class="line">        &#125; catch (\Exception $e) &#123;</span><br><span class="line">            // $e-&gt;getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">        return $this-&gt;alipay-&gt;success()-&gt;send();</span><br><span class="line">        //exit();</span><br><span class="line">        //$this-&gt;load-&gt;view(&apos;assemble_pay/ali_pay_notify&apos;, $res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 方法 check_ali_pay_params，支付包支付返回的参数校验</span><br><span class="line">     *</span><br><span class="line">     * @param array $params 参数数组</span><br><span class="line">     * @param string $order_status 订单状态</span><br><span class="line">     *</span><br><span class="line">     */</span><br><span class="line">    private function check_ali_pay_params($params, $order_status)&#123;</span><br><span class="line">        $order_info_where = [&apos;o.order_no&apos; =&gt; $params[&apos;out_trade_no&apos;], &apos;order_status&apos; =&gt; $order_status];//1，未支付，3：已支付，4：关闭，5：完成</span><br><span class="line">        $order = $this-&gt;assemble_pay_s-&gt;get_order_info_serv($order_info_where);</span><br><span class="line">        if($order_status == 3 &amp;&amp; empty($order))&#123;</span><br><span class="line">            return $order;</span><br><span class="line">        &#125;</span><br><span class="line">        if(empty($order)) output_error(-1, &apos;订单状态异常，订单不存在，请联系卖家！&apos;);</span><br><span class="line">        if($order[&apos;order_money&apos;] != $params[&apos;total_amount&apos;]) output_error(-1, &apos;订单金额异常，订单金额与实际支付金额不一致，请联系卖家确认！&apos;);</span><br><span class="line">        return $order;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 方法 create_order_bill，创建订单流水记录</span><br><span class="line">     *</span><br><span class="line">     * @param array $order 订单信息</span><br><span class="line">     *</span><br><span class="line">     * @param string $trade_no 支付宝交易流水号</span><br><span class="line">     *</span><br><span class="line">     */</span><br><span class="line">    private function create_order_bill($order, $trade_no)&#123;</span><br><span class="line">        $this-&gt;load-&gt;model(&apos;XT_Model&apos;);</span><br><span class="line">        $order_bill = $this-&gt;XT_Model-&gt;execute(&quot;select f_bill_no() as order_bill_no&quot;);</span><br><span class="line">        $order_bill_no = $order_bill[&apos;order_bill_no&apos;];</span><br><span class="line">        $order_bill_data = [</span><br><span class="line">            &apos;order_id&apos; =&gt; $order[&apos;order_id&apos;],</span><br><span class="line">            &apos;order_bill_no&apos; =&gt; $order_bill_no,</span><br><span class="line">            &apos;trade_no&apos; =&gt; $trade_no,</span><br><span class="line">            &apos;bill_date&apos; =&gt; date(&apos;Y-m-d H:i:s&apos;, time()),</span><br><span class="line">            &apos;income&apos; =&gt; $order[&apos;order_money&apos;],</span><br><span class="line">            &apos;pay&apos; =&gt; &apos;0&apos;,</span><br><span class="line">            &apos;balance&apos; =&gt; &apos;0&apos;,</span><br><span class="line">            &apos;bill_period&apos; =&gt; date(&apos;Ym&apos;, time()),</span><br><span class="line">            &apos;remark&apos; =&gt; &apos;购物下单&apos;,</span><br><span class="line">        ];</span><br><span class="line">        $res = $this-&gt;assemble_pay_s-&gt;create_order_bill_serv($order_bill_data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 方法 wechat_pay_notify，微信支付异步回调接口</span><br><span class="line">     *</span><br><span class="line">     */</span><br><span class="line">    public function wechat_pay_notify()</span><br><span class="line">    &#123;</span><br><span class="line">        $pay = Pay::wechat($this-&gt;wechat_pay_cfg);</span><br><span class="line"></span><br><span class="line">        try&#123;</span><br><span class="line">            $result = $pay-&gt;verify(); // 是的，验签就这么简单！</span><br><span class="line"></span><br><span class="line">            Log::debug(&apos;Wechat notify&apos;, $result-&gt;all());</span><br><span class="line">        &#125; catch (\Exception $e) &#123;</span><br><span class="line">            // $e-&gt;getMessage();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return $pay-&gt;success()-&gt;send();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>service服务层文件，assemble_pay_service.php：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">defined(&apos;BASEPATH&apos;) OR exit(&apos;No direct script access allowed&apos;);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by PhpStorm.</span><br><span class="line"> * User: 15237</span><br><span class="line"> * Date: 2019/6/22</span><br><span class="line"> * Time: 15:54</span><br><span class="line"> */</span><br><span class="line">use Yansongda\Pay\Pay;</span><br><span class="line">use Yansongda\Pay\Log;</span><br><span class="line"></span><br><span class="line">class assemble_pay_service</span><br><span class="line">&#123;</span><br><span class="line">    public $CI;</span><br><span class="line">    public $_order_tb = &apos;order&apos;;</span><br><span class="line">    public $_product_tb = &apos;product&apos;;</span><br><span class="line">    public $_order_det_tb = &apos;order_det&apos;;</span><br><span class="line">    public $_order_bill_tb = &apos;order_bill&apos;;</span><br><span class="line"></span><br><span class="line">    protected $alipay_cfg;//支付宝支付配置</span><br><span class="line">    protected $wechat_pay_cfg;//微信支付配置</span><br><span class="line">    protected $alipay;//支付宝支付对象</span><br><span class="line">    protected $wechatpay;//微信支付对象</span><br><span class="line"></span><br><span class="line">    function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;CI = get_instance();</span><br><span class="line">        //$this-&gt;config-&gt;load(&apos;pay_config&apos;);</span><br><span class="line">        $this-&gt;alipay_cfg = $this-&gt;CI-&gt;config-&gt;item(&apos;ali_pay_cfg&apos;);</span><br><span class="line">        $this-&gt;wechat_pay_cfg = $this-&gt;CI-&gt;config-&gt;item(&apos;wechat_pay_cfg&apos;);</span><br><span class="line"></span><br><span class="line">        $this-&gt;CI-&gt;load-&gt;helper(&apos;pay&apos;);</span><br><span class="line"></span><br><span class="line">        $this-&gt;alipay = Pay::alipay($this-&gt;alipay_cfg);</span><br><span class="line">        //$this-&gt;wechatpay = Pay::wechat($this-&gt;wechat_pay_cfg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 方法 pay_serv，聚合支付判断方法</span><br><span class="line">     *</span><br><span class="line">     * @param array $params 参数数组</span><br><span class="line">     *</span><br><span class="line">     */</span><br><span class="line">    public function pay_serv($params)&#123;</span><br><span class="line">        //1.参数数组两边去空处理</span><br><span class="line">        $params = deal_ary_trim($params);</span><br><span class="line"></span><br><span class="line">        //2.判断支付类型调用相关方法</span><br><span class="line">        if(!array_key_exists(&apos;pay_type&apos;, $params)) output_error(-1, &apos;支付类型参数为空或不存在，无法进行支付！&apos;);</span><br><span class="line">        if(!array_key_exists(&apos;pay_way&apos;, $params)) output_error(-1, &apos;支付方式参数为空或不存在，无法进行支付！&apos;);</span><br><span class="line">        $pay_type = $params[&apos;pay_type&apos;];</span><br><span class="line">        $pay_way = $params[&apos;pay_way&apos;];</span><br><span class="line">        unset($params[&apos;pay_type&apos;], $params[&apos;pay_way&apos;]);</span><br><span class="line"></span><br><span class="line">        //3.检查订单是否存在</span><br><span class="line">        $check_where = [&apos;order_no&apos;=&gt;&quot;&apos;&quot;.$params[&apos;order_no&apos;].&quot;&apos;&quot;, &apos;order_status&apos;=&gt;1];</span><br><span class="line">        check_exists_name($check_where, $this-&gt;_order_tb, -1, &apos;付款失败，订单不存在或不在待付款状态！&apos;,1);</span><br><span class="line"></span><br><span class="line">        //4.修改订单状态:支付中</span><br><span class="line">        /*</span><br><span class="line">        $order_where = [&apos;order_no&apos;=&gt;$params[&apos;order_no&apos;]];</span><br><span class="line">        $order_data = [&apos;order_status&apos;=&gt;2,&apos;pay_type&apos;=&gt;$pay_type];</span><br><span class="line">        $this-&gt;update_order_serv($order_where, $order_data);</span><br><span class="line">        */</span><br><span class="line"></span><br><span class="line">        //5.库存检查</span><br><span class="line">        //$this-&gt;check_product_num($params[&apos;order_no&apos;]);</span><br><span class="line"></span><br><span class="line">        //5.获取订单详情信息</span><br><span class="line">        $order_info_where = [&apos;o.order_no&apos; =&gt; $params[&apos;order_no&apos;], &apos;order_status&apos; =&gt; 1];//1，未支付，3：已支付，4：关闭，5：完成</span><br><span class="line">        $order = $this-&gt;get_order_info_serv($order_info_where);</span><br><span class="line">        if(empty($order)) output_error(-1, &apos;付款失败，不存在未付款的订单记录！&apos;);</span><br><span class="line">        $order_name = $order[&apos;order_name&apos;];</span><br><span class="line">        $data = [</span><br><span class="line">            &apos;order_no&apos; =&gt; $order[&apos;order_no&apos;],</span><br><span class="line">            &apos;order_money&apos; =&gt; $order[&apos;order_money&apos;],</span><br><span class="line">            &apos;order_name&apos; =&gt; mb_strlen($order_name) &gt; 256 ? (mb_substr($order_name, 0, 252).&apos;等&apos;) : $order_name,</span><br><span class="line">            &apos;auth_code&apos; =&gt; $order[&apos;auth_code&apos;] ?? &apos;&apos;,</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        switch($pay_type)&#123;</span><br><span class="line">            case &apos;ali_pay&apos;:</span><br><span class="line">                $this-&gt;ali_pay_serv($pay_way, $data);</span><br><span class="line">                break;</span><br><span class="line">            case &apos;wechat_pay&apos;:</span><br><span class="line">                $this-&gt;wechat_pay_serv($pay_way, $data);</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                output_error(-1, &apos;未知的支付类型，请确认！&apos;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     *方法 check_product_num，付款前核对订单库存</span><br><span class="line">     *</span><br><span class="line">     * @param string $order_no 订单编号（数据库订单唯一编号）</span><br><span class="line">     *</span><br><span class="line">     */</span><br><span class="line">    public function check_product_num()&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 方法 get_order_info_serv，获取订单信息</span><br><span class="line">     *</span><br><span class="line">     * @param array $where 条件数组</span><br><span class="line">     *</span><br><span class="line">     * @return array $order 返回订单信息数组</span><br><span class="line">     *</span><br><span class="line">     */</span><br><span class="line">    public function get_order_info_serv($where)&#123;</span><br><span class="line">        $fields = &quot;o.order_id, o.order_no, o.order_status, o.order_money, group_concat(product_name) as order_name&quot;;</span><br><span class="line">        $order = $this-&gt;CI-&gt;db-&gt;select($fields, true)</span><br><span class="line">                          -&gt;from($this-&gt;_order_tb.&apos; as o&apos;)</span><br><span class="line">                          -&gt;join($this-&gt;_order_det_tb, $this-&gt;_order_det_tb.&apos;.order_no=o.order_no&apos;)</span><br><span class="line">                          -&gt;where($where)</span><br><span class="line">                          -&gt;group_by($this-&gt;_order_det_tb.&apos;.order_no&apos;)</span><br><span class="line">                          -&gt;get()</span><br><span class="line">                          -&gt;row_array();</span><br><span class="line">        return $order;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 方法 update_order_serv，更新订单信息</span><br><span class="line">     *</span><br><span class="line">     * @param array $where 条件数组</span><br><span class="line">     * @param array $data 更新数据</span><br><span class="line">     *</span><br><span class="line">     */</span><br><span class="line">    public function update_order_serv($where, $data)&#123;</span><br><span class="line">        $this-&gt;CI-&gt;load-&gt;model(&apos;XT_Model&apos;);</span><br><span class="line">        $this-&gt;CI-&gt;XT_Model-&gt;mTable = $this-&gt;_order_tb;</span><br><span class="line">        $res = $this-&gt;CI-&gt;XT_Model-&gt;update_by_where($where, $data);</span><br><span class="line">        return $res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 方法 get_order_bill_info_serv，获取订单流水信息</span><br><span class="line">     *</span><br><span class="line">     * @param array $where 条件数组</span><br><span class="line">     *</span><br><span class="line">     * @return array $order_bill 返回订单流水信息数组</span><br><span class="line">     *</span><br><span class="line">     */</span><br><span class="line">    public function get_order_bill_info_serv($where)&#123;</span><br><span class="line">        $fields = &quot;order_bill_id, order_id, order_bill_no, trade_no, remark&quot;;</span><br><span class="line">        $order_bill = $this-&gt;CI-&gt;db-&gt;select($fields, true)</span><br><span class="line">            -&gt;from($this-&gt;_order_bill_tb)</span><br><span class="line">            -&gt;where($where)</span><br><span class="line">            -&gt;get()</span><br><span class="line">            -&gt;row_array();</span><br><span class="line">        return $order_bill;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 方法 create_order_bill_serv，新增订单流水记录</span><br><span class="line">     *</span><br><span class="line">     * @param array $data 插入数据数组</span><br><span class="line">     *</span><br><span class="line">     */</span><br><span class="line">    public function create_order_bill_serv($data)&#123;</span><br><span class="line">        $this-&gt;CI-&gt;load-&gt;model(&apos;XT_Model&apos;);</span><br><span class="line">        $this-&gt;CI-&gt;XT_Model-&gt;mTable = $this-&gt;_order_bill_tb;</span><br><span class="line">        $res = $this-&gt;CI-&gt;XT_Model-&gt;insert_string($data);</span><br><span class="line">        return $res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 方法 ali_pay_serv，支付宝支付方法</span><br><span class="line">     *</span><br><span class="line">     * @param string $pay_way 支付方式</span><br><span class="line">     * @param array $params 参数数组</span><br><span class="line">     *</span><br><span class="line">     */</span><br><span class="line">    private function ali_pay_serv($pay_way, $params)&#123;</span><br><span class="line">        //判断支付方式，拼装发起支付的参数数组</span><br><span class="line">        $data = [</span><br><span class="line">            &apos;out_trade_no&apos; =&gt; $params[&apos;order_no&apos;],</span><br><span class="line">            &apos;total_amount&apos; =&gt; round($params[&apos;order_money&apos;]/100, 2),</span><br><span class="line">            &apos;subject&apos;      =&gt; $params[&apos;order_name&apos;],</span><br><span class="line">            // &apos;http_method&apos;  =&gt; &apos;GET&apos; // 如果想在 wap 支付时使用 GET 方式提交，请加上此参数。默认使用 POST 方式提交</span><br><span class="line">        ];</span><br><span class="line">        //5.发起支付</span><br><span class="line">        switch($pay_way)&#123;</span><br><span class="line">            case &apos;web&apos;://电脑支付</span><br><span class="line">                $pay_res = $this-&gt;alipay-&gt;web($data)-&gt;send();</span><br><span class="line">                output_data([&apos;html_str&apos;=&gt;$pay_res-&gt;getContent()]);</span><br><span class="line">                break;</span><br><span class="line">            case &apos;wap&apos;://手机网站支付</span><br><span class="line">                $pay_res = $this-&gt;alipay-&gt;wap($data)-&gt;send();</span><br><span class="line">                break;</span><br><span class="line">            case &apos;app&apos;://app支付</span><br><span class="line">                $pay_res = $this-&gt;alipay-&gt;app($data)-&gt;send();</span><br><span class="line">                break;</span><br><span class="line">            case &apos;pos&apos;://刷卡支付</span><br><span class="line">                $data[&apos;auth_code&apos;] = $params[&apos;auth_code&apos;];</span><br><span class="line">                $pay_res = $this-&gt;alipay-&gt;pos($data);</span><br><span class="line">                break;</span><br><span class="line">            case &apos;scan&apos;://扫码支付</span><br><span class="line">                $pay_res = $this-&gt;alipay-&gt;scan($data);</span><br><span class="line">                break;</span><br><span class="line">            case &apos;transfer&apos;://账户转账</span><br><span class="line">                $order = [</span><br><span class="line">                    &apos;out_biz_no&apos; =&gt; time(),</span><br><span class="line">                    &apos;payee_type&apos; =&gt; &apos;ALIPAY_LOGONID&apos;,</span><br><span class="line">                    &apos;payee_account&apos; =&gt; &apos;ghdhjw7124@sandbox.com&apos;,</span><br><span class="line">                    &apos;amount&apos; =&gt; &apos;0.01&apos;,</span><br><span class="line">                ];</span><br><span class="line">                $pay_res = $this-&gt;alipay-&gt;transfer($order);</span><br><span class="line">                break;</span><br><span class="line">            case &apos;mini&apos;://小程序支付</span><br><span class="line">                $data[&apos;buyer_id&apos;] = $params[&apos;buyer_id&apos;];</span><br><span class="line">                $pay_res = $this-&gt;alipay-&gt;mini($data);</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                output_error(-1, &apos;未知的支付方式，请确认！&apos;);</span><br><span class="line">        &#125;</span><br><span class="line">        return $pay_res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 方法 wechat_pay_serv，微信支付方法</span><br><span class="line">     *</span><br><span class="line">     * @param string $pay_way 支付方式</span><br><span class="line">     * @param array $params 参数数组</span><br><span class="line">     *</span><br><span class="line">     */</span><br><span class="line">    private function wechat_pay_serv($pay_way, $params)&#123;</span><br><span class="line">        //判断支付方式，拼装发起支付的参数数组</span><br><span class="line">        $data = [</span><br><span class="line"></span><br><span class="line">        ];</span><br><span class="line">        //判断支付方式，拼装发起支付的参数数组</span><br><span class="line">        switch($pay_way)&#123;</span><br><span class="line">            case &apos;mp&apos;://公众号支付</span><br><span class="line">                break;</span><br><span class="line">            case &apos;miniapp&apos;://小程序支付</span><br><span class="line">                break;</span><br><span class="line">            case &apos;wap&apos;://H5支付</span><br><span class="line">                break;</span><br><span class="line">            case &apos;scan&apos;://扫码支付</span><br><span class="line">                break;</span><br><span class="line">            case &apos;pos&apos;://刷卡支付</span><br><span class="line">                break;</span><br><span class="line">            case &apos;app&apos;://app只发</span><br><span class="line">                break;</span><br><span class="line">            case &apos;transfer&apos;://企业付款</span><br><span class="line">                break;</span><br><span class="line">            case &apos;redpack&apos;://普通红包</span><br><span class="line">                break;</span><br><span class="line">            case &apos;groupRedpack&apos;://分类红包</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                output_error(-1, &apos;未知的支付方式，请确认！&apos;);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        //5.发起支付</span><br><span class="line">        $pay = Pay::wechat($this-&gt;wechat_pay_cfg)-&gt;mp($data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同步通知跳转页面文件ali_pay_return.php：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE HTML&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot;&gt;</span><br><span class="line">        &lt;title&gt;支付宝电脑网站支付return_url&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">    &lt;?php</span><br><span class="line">        if($res == &apos;success&apos;)&#123;</span><br><span class="line">            echo sprintf($message, $trade_no);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            echo $message;</span><br><span class="line">        &#125;</span><br><span class="line">    ?&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>以上是支付宝PC网站支付的业务代码，从支付到异步回调通知，再到同步回调通知，仅供参考，欢迎交流。</p><h1 id="开发接入注意事项"><a href="#开发接入注意事项" class="headerlink" title="开发接入注意事项"></a>开发接入注意事项</h1><h2 id="insufficient-isv-permissions，错误原因-ISV权限不足"><a href="#insufficient-isv-permissions，错误原因-ISV权限不足" class="headerlink" title="insufficient-isv-permissions，错误原因: ISV权限不足"></a>insufficient-isv-permissions，错误原因: ISV权限不足</h2><p>问题原因：<br>应用未上线或支付服务未签约，参考：<a href="https://openclub.alipay.com/club/history/read/13201" target="_blank" rel="noopener">https://openclub.alipay.com/club/history/read/13201</a><br>解决方案参考：</p><ul><li>应用未上线：把项目上线后进行支付测试</li><li>未签约，参考文档：<a href="https://blog.csdn.net/meixi_android/article/details/86489870" target="_blank" rel="noopener">https://blog.csdn.net/meixi_android/article/details/86489870</a><h2 id="同步通知验签失败"><a href="#同步通知验签失败" class="headerlink" title="同步通知验签失败"></a>同步通知验签失败</h2>问题原因：<br>配置文件中ali_public_key使用的是支付宝公钥，而不是应用公钥<br>解决方案：<br>去支付宝开发者平台查看支付宝公钥，或到最开始使用秘钥生成工具生成的公钥文件中复制公钥内容，注意公钥中不需要带回车换行符，使用时应去掉，且不包含—–BEGIN PUBLIC KEY—–和—–END PUBLIC KEY—–<br><img src="http://ptx9vod5s.bkt.clouddn.com/blog/alipay-pc-07.png" alt="在这里插入图片描述"><h2 id="异步通知验签失败"><a href="#异步通知验签失败" class="headerlink" title="异步通知验签失败"></a>异步通知验签失败</h2>问题原因：<br>可能是由于支付宝post请求返回的参数编码市GBK，导致中文乱码，致使验签失败，在我使用的这个SDK中，由于支付宝网关设置成了常量，且不能在SDK中直接修改（因为修改过后，每次执行composer都会更新掉，如果不更新代码，可以在网关后面加上?charset=utf-8，指定编码格式解决），所以使用字符编码转换处理。<br>解决方案：<br>使用php://input流接收参数，处理中文字符编码问题。<br><img src="http://ptx9vod5s.bkt.clouddn.com/blog/alipay-pc-08.png" alt="在这里插入图片描述"><br>完整代码参考上面代码块文件。</li></ul><h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>从支付开始开发，到支付功能开发完成，深有体会的是，可能代码的编写、业务逻辑处理并不是最难的，最难的是对于支付账号信息，你摸不到、碰不了，可能本来给你的信息就是错的，你以为是对的（就像支付宝公钥给成了应用公钥），这是最痛苦的事情，所以，开发之前或者测试出问题的时候，一定要先确认配置信息的正确性，否则可能永远都找不到问题。</p><center style="font-size:18px"><b>********************只要思想不滑坡，办法总比困难多********************</b></center>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;本文是基于PHP框架CI3.X开发的接入支付宝PC网站支付流程步骤，是从注册成为支付宝支付开发者的沙箱环境，到正式支付服务签约，一级接口业务开发，和开发过程中遇到的问题，还有相应的解决方案。旨在记录开发过程，期望为初次接触支付宝支付的开发者提供一个思路。&lt;/p&gt;
&lt;p&gt;&lt;i
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://blog.monty.site/2019/06/30/hello-world/"/>
    <id>http://blog.monty.site/2019/06/30/hello-world/</id>
    <published>2019-06-30T13:22:46.761Z</published>
    <updated>2019-06-30T13:22:46.762Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
  </entry>
  
</feed>
